<!DOCTYPE html>
<!-- saved from url=(0101)file:///D:/!!Documents/!_html/web_philcrowther.com/WebGL/Seas_WebGPU_alone/iFFT_LAB2_231201_r159.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>iFFT LAB2 - Nodes</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
body {
	overflow: hidden;
	margin:0;
	color: black;
	font-family: Courier;
	font-size: 20pt;
	font-weight: bold;
}
</style>
</head>

<body oncontextmenu="return false;">

<script type="importmap">
	{
		"imports": {
			"three": "https://unpkg.com/three@0.163.0/build/three.module.js", 
			"three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/",
			"three/nodes": "https://unpkg.com/three@0.163.0/examples/jsm/nodes/Nodes.js"
		}
	}
</script>

<script type="module">

import * as THREE from "three";
import {OrbitControls} from "three/addons/controls/OrbitControls.js";
import Stats from "three/addons/libs/stats.module.js";
import {Lensflare, LensflareElement} from "three/addons/objects/Lensflare.js";
import {
		color,
		texture,
		normalMap,
		float,
		vec2,
		attribute,
		positionLocal,
		MeshStandardNodeMaterial,
} from 'three/nodes';
import {nodeFrame} from 'three/addons/renderers/webgl-legacy/nodes/WebGLNodes.js';	// ### Nodes

/*= VARIABLES ================================================================*/
//-	Sky
let SkyCol = 0x1732c1;			// Sky
let FogCol = 0xbab4a6;			// Sky (for Fog only)
let SkyLim = 100000;			// Max viewing distance
//- Sun
let SunCol = 0xffffff;			// Sun
let	SunLLD = new THREE.Vector3(23,312,1000);	// Lat,Lon,Dst for Sun Mesh and Lensflare
let	SunPos = new THREE.Vector3();
//-	Math Predefined
var PieVal = Math.PI;			// PI
var DegRad = PieVal / 180;		// Convert Degrees to Radians
var RadDeg = 180 / PieVal;		// Convert Radians to Degrees
//-	Stats
let stats = 0;
//- Flags
let StsFlg = 1;					// Stats ((0 = off, 1 = on)
let LodFlg = 0;
//- Misc
let V3temp = new THREE.Vector3();
let quaternion = new THREE.Quaternion();
let CamMsh = makMsh();
	CamMsh.rotation.order = "YXZ";
let CamRot = new THREE.Vector2();
let SunOff = new THREE.Vector2();

//= Textures ===================================================================
//- SkyBox
let SBPath = "https://threejs.org/examples/textures/cube/skyboxsun25deg/";
//-	LensFlare
let LF0Src = "https://threejs.org/examples/textures/lensflare/lensflare1.png";
let LF1Src = "https://threejs.org/examples/textures/lensflare/hexangle.png";
let LF0Txt, LF1Txt = 0;
let Sp0Src = "https://threejs.org/examples/textures/sprite1.png";
let Sp1Src = "https://threejs.org/examples/textures/sprite1.png";
let Sp0Txt, Sp1Txt = 0;
let sprite0, sprite1 = 0;


//= BASIC VALUES ===============================================================
let	container = document.createElement('div');
	document.body.appendChild(container);
//- Camera
let	camera = new THREE.PerspectiveCamera(55.0, window.innerWidth/window.innerHeight, 0.5, SkyLim);
	camera.position.set(0, 350, 800);
//- Scene
let	scene = new THREE.Scene();
//- Renderer
let	renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize(window.innerWidth,window.innerHeight);
	renderer.setAnimationLoop(rendAll);
	renderer.shadowMap.enabled = true;
	renderer.shadowMap.autoUpdate = true;
	renderer.receiveShadow = true;
	renderer.shadowMap.type = THREE.BasicShadowMap;
	container.appendChild(renderer.domElement);
//- Lights
let sunLight = new THREE.DirectionalLight(SunCol, 3.0);
	scene.add(sunLight);
let sunPos = new THREE.Vector3();		// Normalized value
//- Controls
let	controls = new OrbitControls(camera, renderer.domElement);
//- Clock
let clock = new THREE.Clock();
let oldTim, nowTim, difTim = 0;
//- Inputs
	window.addEventListener("resize", onWindowResize, false);
//- Loading Manager
	// Create a loading manager to set RESOURCES_LOADED when appropriate.
	// Pass loadingManager to all resource loaders.
let loadingManager = new THREE.LoadingManager();
let RESOURCES_LOADED = false;
	loadingManager.onLoad = function(){
		console.log("loaded all resources");
		RESOURCES_LOADED = true;
		initAll();
	};
let txtrLoader = new THREE.TextureLoader(loadingManager);

/*= MAIN PROGRAM =============================================================*/
	loadAll();

/*= 0 LOAD ALL ===============================================================*/
function loadAll() {
	loadSkyBox();
}

/*= 1 INITIALIZE =============================================================*/
function initAll() {
	initSkyBox();						// Sky, Fog and Sun
	// Show stats
	if (StsFlg) {						// show stats
		stats = new Stats();
		stats.setMode(0);				// FPS only
		stats.domElement.style.cssText = "position:absolute;top:95%;left:90%;";
		container.appendChild(stats.dom);
	}
	LodFlg = 1;
}

/*= 2 RENDER =================================================================*/
function rendAll() {
//	requestAnimationFrame(rendAll);
	nodeFrame.update();					// ### Nodes	
	if (LodFlg > 0) {
		// Update time
		nowTim = clock.getElapsedTime();
		difTim = nowTim-oldTim;
		oldTim = nowTim;
		//
		moveSkyBox();
		controls.update();				// Controls
		if (StsFlg) stats.update();		// Stats
	}
	renderer.render(scene, camera);		// Render
}

//= SKY BOX ====================================================================

function loadSkyBox() {
	let fpath = SBPath;
	let envMap = new THREE.CubeTextureLoader(loadingManager)
		.setPath(fpath)
		.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"]);
	envMap.format = THREE.RGBAFormat;
	envMap.colorSpace = THREE.SRGBColorSpace;	// ### r152
	scene.background = envMap;
	// LensFlare
	LF0Txt = txtrLoader.load(LF0Src);
	LF1Txt = txtrLoader.load(LF1Src);
	Sp0Txt = txtrLoader.load(Sp0Src);
	Sp1Txt = txtrLoader.load(Sp1Src);
}

function initSkyBox() {
	// Scrolling Map Max Distance = 81,000 units (81,000 meters = 50.33 miles)
	// (=.5 * (27 outer squares * 3 inner per outer * 2000 inner square size))
	// Fog (doesn't work with Normal Material)
	scene.fog = new THREE.Fog(FogCol, 0.25, 95000);	// less than camera distance, sky colored fog
	// SunLight Position
let SunPos = new THREE.Vector3(SunLLD.x,Mod360(180-SunLLD.y),SunLLD.z);
	SunPos = rotLLD(SunPos);	// Set Position above Light
	sunLight.position.copy(SunPos).normalize();	
	// Lensflare
let	spotLight = new THREE.PointLight(0xffffff);
	scene.add(spotLight);
	spotLight.position.copy(SunPos);
	let LF = new Lensflare();
	LF.addElement(new LensflareElement(LF0Txt, 256, 0));
	LF.addElement(new LensflareElement(LF1Txt, 32, 0.2));
	LF.addElement(new LensflareElement(LF1Txt, 256, 0.9));
	spotLight.add(LF);
	// Lensflare (alt)
//	let mat0 = new THREE.SpriteMaterial({
//		color:  0xffffff,
//		map: LF0Txt,
//		transparent:true,
//		depthWrite:false,
//		opacity: 0.1
//	});
	let mat0 = new THREE.SpriteMaterial({map: Sp1Txt, color: 0xffffff});
	let mat1 = new THREE.SpriteMaterial({map: Sp1Txt, color: 0xffffff});
	sprite0 = new THREE.Sprite(mat0);
	sprite1 = new THREE.Sprite(mat1);
	sprite0.position.copy(sunLight.position);
	sprite0.position.multiplyScalar(500);
	sprite0.scale.set(50,50,1);
	scene.add(sprite0);
	sprite1.position.copy(sunLight.position);
	sprite1.position.multiplyScalar(-300);
	sprite1.scale.set(100,100,1);
	scene.add(sprite1);
}

function moveSkyBox() {
	sprite0.visible = true;	
	sprite1.visible = true;
	let off = 0;
	camera.getWorldQuaternion(quaternion);
	CamMsh.setRotationFromQuaternion(quaternion);
	CamRot.x = CamMsh.rotation.x*RadDeg;
	CamRot.y = -CamMsh.rotation.y*RadDeg;
//	console.log(CamRot.x,CamRot.y);
	SunOff.x = SunLLD.x - CamRot.x;
	SunOff.y = PoM360(Mod360(SunLLD.y - CamRot.y));
//	console.log(SunOff.x,SunOff.y);
	SunOff.x = Math.abs(Math.round(SunOff.x));
	SunOff.y = Math.abs(Math.round(SunOff.y));
//	console.log(SunOff.x,SunOff.y);
	let ratio = window.innerWidth / window.innerHeight;
	if (SunOff.x > 45 || SunOff.y > 45*ratio) off = 1;
	if (off) sprite0.visible = false;
	if (off) sprite1.visible = false;
}

//- Rotates Vector -------------------------------------------------------------
function rotLLD(LLD) {
	let lat = LLD.x*DegRad;
	let lon = LLD.y*DegRad;
	// Latitude
	LLD.y = LLD.z * Math.sin(lat);
	LLD.z = LLD.z * Math.cos(lat);
	// Longitude
	LLD.x = LLD.z * Math.sin(lon);
	LLD.z = LLD.z * Math.cos(lon);
	return LLD;
}

/*= 4 MISC SUBROUTINES =======================================================*/

//- Converts degrees to 360
function Mod360(deg) {
	while (deg < 0) deg = deg+360;	// Make deg a positive number
	deg = deg % 360;				// Compute remainder of any number divided by 360
return deg;}

//  Converts 360 degrees to +/- 180
function PoM360(deg) {
	if (deg > 180) deg = deg-360;
return deg;}

//- Rotates Vector
function RoteV3(lon,lat,dst) {
	// Latitude
	V3temp.y = dst * Math.sin(lat);
	V3temp.z = dst * Math.cos(lat);
	// Longitude
	V3temp.x = V3temp.z * Math.sin(lon);
	V3temp.z = V3temp.z * Math.cos(lon);
return V3temp;}

function makMsh() {
	let geometry = new THREE.BoxGeometry(0.01,0.01,0.01); 
	let material = new THREE.MeshBasicMaterial({transparent:true,opacity:0}); 
	let mesh = new THREE.Mesh(geometry, material);
return mesh;}

//= Window Resize Input ========================================================
function onWindowResize() {
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth, window.innerHeight);
}

</script>
</body>
</html>