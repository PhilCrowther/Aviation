<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>LensFlare GPU test</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
body {
	overflow: hidden;
	margin:0;
	color: black;
	font-family: Courier;
	font-size: 20pt;
	font-weight: bold;
}
</style>
</head>

<body oncontextmenu="return false;">

<script type="importmap">
	{
		"imports": {
			"three": "https://unpkg.com/three@0.166.1/build/three.module.js", 
			"three/addons/": "https://unpkg.com/three@0.166.1/examples/jsm/",
			"three/nodes": "https://unpkg.com/three@0.166.1/examples/jsm/nodes/Nodes.js"
		}
	}
</script>

<script type="module">

import * as THREE from "three";
import WebGPU from 'three/addons/capabilities/WebGPU.js';
import WebGPURenderer from 'three/addons/renderers/webgpu/WebGPURenderer.js';
import {OrbitControls} from "three/addons/controls/OrbitControls.js";
import Stats from "three/addons/libs/stats.module.js";
import {Lensflare, LensflareElement} from "three/addons/objects/Lensflare.js";

//= VARIABLES ==================================================================
//-	Sky
let SkyCol = 0x1732c1;			// Sky
let FogCol = 0xbab4a6;			// Sky (for Fog only)
let SkyLim = 100000;			// Max viewing distance
//- Sun
let SunCol = 0xffffff;			// Sun
let SunDst = 10000;				// for shadows and lensflare
let	SunLLD = new THREE.Vector3(23,312,SunDst);	// Lat,Lon,Dst for Sun Mesh and Lensflare
//-	Math Predefined
var PieVal = Math.PI;			// PI
var DegRad = PieVal / 180;		// Convert Degrees to Radians
var RadDeg = 180 / PieVal;		// Convert Radians to Degrees
//-	Stats
let stats = 0;
//- Flags
let StsFlg = 1;					// Stats ((0 = off, 1 = on)
let LodFlg = 0;
//- Misc
let V3temp = new THREE.Vector3();

//= SKYBOX =====================================================================
let SBPath = "https://threejs.org/examples/textures/cube/skyboxsun25deg/";

//=	LENSFLARE ==================================================================
let LFsrc0 = "https://threejs.org/examples/textures/lensflare/lensflare1.png";
let LFsrc1 = "https://threejs.org/examples/textures/lensflare/hexangle.png";
let LFtxt0, LFtxt1 = 0;
let LFspr0, LFspr1 = 0;
let CamMsh = makMsh();
	CamMsh.rotation.order = "YXZ";
let LFcamR = new THREE.Vector2();
let SunOff = new THREE.Vector2();
let quaternion = new THREE.Quaternion();

//= BASIC VALUES ===============================================================
let	container = document.createElement('div');
	document.body.appendChild(container);
//- Camera
let	camera = new THREE.PerspectiveCamera(55.0, window.innerWidth/window.innerHeight, 0.5, SkyLim);
	camera.position.set(600,0,800);
//- Scene
let	scene = new THREE.Scene();
//- Renderer
let renderer = new WebGPURenderer({antialias: true});	// ### WebGPU
    renderer.setPixelRatio(window.devicePixelRatio);
	renderer.setSize(window.innerWidth,window.innerHeight);
	renderer.setAnimationLoop(rendAll);
	renderer.shadowMap.enabled = true;
	renderer.shadowMap.autoUpdate = true;
	renderer.receiveShadow = true;
	renderer.shadowMap.type = THREE.BasicShadowMap;
	container.appendChild(renderer.domElement);
//- Lights
let sunLight = new THREE.DirectionalLight(SunCol, 3.0);
	scene.add(sunLight);
//- Controls
let	controls = new OrbitControls(camera, renderer.domElement);
//- Clock
let clock = new THREE.Clock();
let oldTim, nowTim, difTim = 0;
//- Inputs
	window.addEventListener("resize", onWindowResize, false);
//- Loading Manager
	// Create a loading manager to set RESOURCES_LOADED when appropriate.
	// Pass loadingManager to all resource loaders.
let loadingManager = new THREE.LoadingManager();
let RESOURCES_LOADED = false;
	loadingManager.onLoad = function(){
		console.log("loaded all resources");
		RESOURCES_LOADED = true;
		initAll();
	};
let txtrLoader = new THREE.TextureLoader(loadingManager);
let cubeLoader = new THREE.CubeTextureLoader(loadingManager);

//= MAIN PROGRAM ===============================================================
	loadAll();

//= 0 LOAD ALL =================================================================
function loadAll() {
	loadSkyBox();
	loadLensFl();						// LensFlare
}

//= 1 INITIALIZE ===============================================================
function initAll() {
	initSkyBox();						// Sky, Fog and Sun
	initLensFl();						// LensFlare
	// Show stats
	if (StsFlg) {						// show stats
		stats = new Stats();
		stats.setMode(0);				// FPS only
		stats.domElement.style.cssText = "position:absolute;top:95%;left:90%;";
		container.appendChild(stats.dom);
	}
	LodFlg = 1;
}

//= 2 RENDER ===================================================================
function rendAll() {
//	requestAnimationFrame(rendAll);	
	if (LodFlg > 0) {
		// Update time
		nowTim = clock.getElapsedTime();
		difTim = nowTim-oldTim;
		oldTim = nowTim;
		//
		moveLensFl();					// LensFlare
		controls.update();				// Controls
		if (StsFlg) stats.update();		// Stats
	}
	renderer.render(scene, camera);		// Render
}

//= SKY BOX ====================================================================

function loadSkyBox() {
	let envMap = cubeLoader
		.setPath(SBPath)
		.load(["px.jpg", "nx.jpg", "py.jpg", "ny.jpg", "pz.jpg", "nz.jpg"]);
	envMap.format = THREE.RGBAFormat;
	envMap.colorSpace = THREE.SRGBColorSpace;	// ### r152
	scene.background = envMap;
}

function initSkyBox() {
	// Scrolling Map Max Distance = 81,000 units (81,000 meters = 50.33 miles)
	// (=.5 * (27 outer squares * 3 inner per outer * 2000 inner square size))
	// Fog (doesn't work with Normal Material)
	scene.fog = new THREE.Fog(FogCol, 0.25, 95000);	// less than camera distance, sky colored fog
	// SunLight Position
	let SunPos = new THREE.Vector3(SunLLD.x,Mod360(180-SunLLD.y),SunLLD.z);
	SunPos = rotLLD(SunPos);	// Set Position above Light
	sunLight.position.copy(SunPos).normalize();	
}

//- Rotates Vector -------------------------------------------------------------
function rotLLD(LLD) {
	let lat = LLD.x*DegRad;
	let lon = LLD.y*DegRad;
	// Latitude
	LLD.y = LLD.z * Math.sin(lat);
	LLD.z = LLD.z * Math.cos(lat);
	// Longitude
	LLD.x = LLD.z * Math.sin(lon);
	LLD.z = LLD.z * Math.cos(lon);
	return LLD;
}

//= LENSFLARE ==================================================================

function loadLensFl() {
	LFtxt0 = txtrLoader.load(LFsrc1);	// Hex Shape
	LFtxt1 = txtrLoader.load(LFsrc1);	// Hex Shape
}

function initLensFl() {
	let mat0 = new THREE.SpriteMaterial({
		map: LFtxt0,
		blending: THREE.AdditiveBlending,
		depthTest:false,
		depthWrite:false
	});
	let mat1 = new THREE.SpriteMaterial({
		map: LFtxt1,
		blending: THREE.AdditiveBlending,
		depthTest:false,
		depthWrite:false
	});
	LFspr0 = new THREE.Sprite(mat0);
	LFspr1 = new THREE.Sprite(mat1);
	LFspr0.position.copy(sunLight.position);
	LFspr0.position.multiplyScalar(500);
	LFspr0.scale.set(50,50,1);
	scene.add(LFspr0);
	LFspr1.position.copy(sunLight.position);
	LFspr1.position.multiplyScalar(-300);
	LFspr1.scale.set(100,100,1);
	scene.add(LFspr1);
}

function moveLensFl() {
	LFspr0.visible = true;	
	LFspr1.visible = true;
	camera.getWorldQuaternion(quaternion);
	CamMsh.setRotationFromQuaternion(quaternion);
	LFcamR.x = CamMsh.rotation.x*RadDeg;
	LFcamR.y = -CamMsh.rotation.y*RadDeg;
//	console.log(LFcamR.x,LFcamR.y);
	SunOff.x = SunLLD.x - LFcamR.x;
	SunOff.y = PoM360(Mod360(SunLLD.y - LFcamR.y));
//	console.log(SunOff.x,SunOff.y);
	SunOff.x = Math.abs(Math.round(SunOff.x));
	SunOff.y = Math.abs(Math.round(SunOff.y));
//	console.log(SunOff.x,SunOff.y);
	let ratio = window.innerWidth / window.innerHeight;
	if (SunOff.x > 45 || SunOff.y > 45*ratio) {
		LFspr0.visible = false;
		LFspr1.visible = false;
	}
}

//= 4 MISC SUBROUTINES =========================================================

//- Converts degrees to 360
function Mod360(deg) {
	while (deg < 0) deg = deg+360;	// Make deg a positive number
	deg = deg % 360;				// Compute remainder of any number divided by 360
return deg;}

//  Converts 360 degrees to +/- 180
function PoM360(deg) {
	if (deg > 180) deg = deg-360;
return deg;}

//- Rotates Vector
function RoteV3(lon,lat,dst) {
	// Latitude
	V3temp.y = dst * Math.sin(lat);
	V3temp.z = dst * Math.cos(lat);
	// Longitude
	V3temp.x = V3temp.z * Math.sin(lon);
	V3temp.z = V3temp.z * Math.cos(lon);
return V3temp;}

function makMsh() {
	let geometry = new THREE.BoxGeometry(0.01,0.01,0.01); 
	let material = new THREE.MeshBasicMaterial({transparent:true,opacity:0}); 
	let mesh = new THREE.Mesh(geometry, material);
return mesh;}

//= Window Resize Input ========================================================
function onWindowResize() {
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth, window.innerHeight);
}

</script>
</body>
</html>